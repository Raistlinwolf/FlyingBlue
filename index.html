<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flying Blue XP Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 960px;
      margin: auto;
      padding: 1em;
    }
    input, select {
      padding: 0.3em;
      margin: 0.3em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }
    th, td {
      padding: 0.5em;
      border: 1px solid #ccc;
      text-align: center;
    }
    canvas {
      margin-top: 2em;
    }
    .autocomplete-dropdown {
      position: absolute;
      border: 1px solid #ccc;
      background: white;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      width: 100%;
    }
    .autocomplete-dropdown div {
      padding: 8px 12px;
      cursor: pointer;
    }
    .autocomplete-dropdown div:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1>Flying Blue XP 計算器</h1>

  <form id="flight-form">
    <label>出發機場:
      <input type="text" id="origin" autocomplete="off" required>
    </label>
    <label>轉機1:
      <input type="text" id="stop1" autocomplete="off">
    </label>
    <label>轉機2:
      <input type="text" id="stop2" autocomplete="off">
    </label>
    <label>目的地:
      <input type="text" id="destination" autocomplete="off" required>
    </label><br>

    <label>艙等:
      <select id="cabin">
        <option value="economy">Economy</option>
        <option value="premium">Premium Economy</option>
        <option value="business">Business</option>
        <option value="first">First</option>
      </select>
    </label>

    <label><input type="checkbox" id="roundtrip"> 來回</label>
    <label><input type="checkbox" id="doublexp"> 雙倍XP</label>
    <button type="submit">新增航班</button>
  </form>

  <ul id="suggestions" class="autocomplete-suggestions"></ul>

  <h3 id="status-info">尚無累積資料</h3>

  <table id="flights-table">
    <thead>
      <tr>
        <th>航線</th>
        <th>艙等</th>
        <th>XP</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <canvas id="xpChart" width="600" height="300"></canvas>

  <script src="airports.js"></script>
  <script src="airportCache.js"></script>
  <script type="module" src="autocomplete.js"></script>
  <script src="xp-calculator.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('flight-form');

      // 初始化 autocomplete 功能
      const airportInputs = ['origin', 'stop1', 'stop2', 'destination'];
      airportInputs.forEach(id => {
        const inputEl = document.getElementById(id);
        setupAirportAutocomplete(inputEl, (selectedAirport) => {
          console.log(`Selected airport: ${selectedAirport.name} (${selectedAirport.iata})`);
        });
      });

      // Handle form submission
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const origin = await getAirportData(document.getElementById('origin').value);
        const stop1 = document.getElementById('stop1').value ? await getAirportData(document.getElementById('stop1').value) : null;
        const stop2 = document.getElementById('stop2').value ? await getAirportData(document.getElementById('stop2').value) : null;
        const destination = await getAirportData(document.getElementById('destination').value);
        const cabin = document.getElementById('cabin').value;
        const roundtrip = document.getElementById('roundtrip').checked;
        const doublexp = document.getElementById('doublexp').checked;

        if (origin && destination) {
          const xp = await calculateXP({ origin, stop1, stop2, destination, cabin, roundtrip, doublexp });
          addFlightToTable({ origin, stop1, stop2, destination, cabin, xp });
        } else {
          alert('請確認所有機場代碼是否正確！');
        }
      });
    });

    async function getAirportData(code) {
      // Fetch airport data from cache or Leaflet
      const cached = await getFromCache(code);
      if (cached) return cached;
      const fetched = await fetchGeoFromLeaflet(code);
      if (fetched) {
        await saveToCache(code, fetched);
        return fetched;
      }
      return null;
    }

    async function calculateXP(data) {
      // Send data to xp-calculator.js and return XP value
      return await calculateXPFromData(data);
    }

    function addFlightToTable({ origin, stop1, stop2, destination, cabin, xp }) {
      const table = document.querySelector('#flights-table tbody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${origin} ${stop1 ? '→ ' + stop1 : ''} ${stop2 ? '→ ' + stop2 : ''} → ${destination}</td>
        <td>${cabin}</td>
        <td>${xp}</td>
        <td><button class="delete-flight">刪除</button></td>
      `;
      table.appendChild(row);

      // Add delete functionality
      row.querySelector('.delete-flight').addEventListener('click', () => {
        row.remove();
      });
    }
  </script>
</body>
</html>
